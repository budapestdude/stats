# Chess Stats - Complete Deployment Guide

## ðŸ“‹ Table of Contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Server Setup](#server-setup)
4. [Application Deployment](#application-deployment)
5. [Database Configuration](#database-configuration)
6. [Web Server Setup](#web-server-setup)
7. [SSL Configuration](#ssl-configuration)
8. [Process Management](#process-management)
9. [Monitoring & Logging](#monitoring--logging)
10. [Backup Strategy](#backup-strategy)
11. [Performance Tuning](#performance-tuning)
12. [Security Checklist](#security-checklist)
13. [Troubleshooting](#troubleshooting)
14. [Maintenance](#maintenance)

---

## Overview

Chess Stats is a comprehensive chess statistics platform that integrates with Chess.com and Lichess APIs, featuring a 9.1M+ game OTB database. This guide covers deploying the application to a production environment.

### Architecture Overview
- **Backend**: Node.js with Express (Port 3010 recommended)
- **Frontend**: Next.js 15 with React 19
- **Database**: SQLite with 9.1M+ games
- **Cache**: Redis (optional but recommended)
- **Web Server**: Nginx (reverse proxy)
- **Process Manager**: PM2 or Docker

---

## Prerequisites

### Minimum Server Requirements
```
OS:         Ubuntu 20.04 LTS or newer
CPU:        2 cores minimum (4+ recommended)
RAM:        4GB minimum (8GB recommended)
Storage:    20GB SSD (50GB+ for growth)
Network:    100Mbps (1Gbps recommended)
```

### Required Software
```bash
- Node.js 18.x LTS or newer
- npm 9.x or newer
- nginx 1.20+
- SQLite 3.35+
- Redis 6.0+ (optional)
- Git 2.x
- PM2 5.x (for process management)
- Docker & Docker Compose (alternative deployment)
```

### Domain & DNS
- A registered domain name
- DNS A record pointing to your server IP
- (Optional) Cloudflare for CDN and DDoS protection

---

## Server Setup

### Step 1: Initial Server Configuration

```bash
# Connect to your server
ssh root@your-server-ip

# Create a new user for the application
adduser chessstats
usermod -aG sudo chessstats

# Switch to the new user
su - chessstats

# Update system packages
sudo apt update && sudo apt upgrade -y

# Install essential packages
sudo apt install -y \
    build-essential \
    curl \
    wget \
    git \
    vim \
    htop \
    ufw \
    fail2ban \
    software-properties-common
```

### Step 2: Install Node.js

```bash
# Install Node.js 18 LTS using NodeSource repository
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# Verify installation
node --version  # Should show v18.x.x
npm --version   # Should show 9.x.x

# Install global packages
sudo npm install -g pm2 npm@latest
```

### Step 3: Install Database & Cache

```bash
# Install SQLite
sudo apt install -y sqlite3 libsqlite3-dev

# Install Redis (optional but recommended)
sudo apt install -y redis-server

# Configure Redis
sudo systemctl enable redis-server
sudo systemctl start redis-server

# Verify Redis
redis-cli ping  # Should return PONG
```

### Step 4: Configure Firewall

```bash
# Setup UFW firewall
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable

# Check status
sudo ufw status
```

---

## Application Deployment

### Step 1: Clone Repository

```bash
# Navigate to home directory
cd ~

# Clone the repository
git clone https://github.com/yourusername/chess-stats.git
cd chess-stats

# Checkout production branch (if applicable)
git checkout production
```

### Step 2: Install Dependencies

```bash
# Install backend dependencies
npm ci --production=false  # Include dev deps for building

# Install and build frontend
cd frontend
npm ci --production=false
npm run build
cd ..

# Build TypeScript files (if using TypeScript)
npm run build
```

### Step 3: Configure Environment

```bash
# Generate production secrets
node scripts/generate-secrets.js

# Copy environment template
cp .env.production.example .env.production

# Edit environment variables
nano .env.production
```

**Essential .env.production settings:**

```env
NODE_ENV=production
PORT=3010
APP_URL=https://your-domain.com

# Database
DB_PATH=./otb-database/complete-tournaments.db

# Redis (if using)
REDIS_ENABLED=true
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password

# Security (generated by scripts/generate-secrets.js)
SESSION_SECRET=your_generated_secret
JWT_SECRET=your_generated_secret
API_KEY=your_generated_api_key

# CORS
CORS_ORIGINS=https://your-domain.com,https://www.your-domain.com

# Monitoring
LOG_LEVEL=info
LOG_DIR=./logs
```

### Step 4: Prepare Database

```bash
# Run database optimization
node scripts/optimize-db.js

# Verify database integrity
sqlite3 otb-database/complete-tournaments.db "PRAGMA integrity_check;"

# Set correct permissions
chmod 644 otb-database/complete-tournaments.db
```

### Step 5: Test Application Locally

```bash
# Start the application in production mode
NODE_ENV=production node simple-server-pooled.js

# In another terminal, test the endpoints
curl http://localhost:3010/health
curl http://localhost:3010/api/stats/database

# If successful, stop the server (Ctrl+C)
```

---

## Database Configuration

### Optimize for Production

```bash
# Run the optimization script
node scripts/optimize-db.js

# This script will:
# - Create performance indexes
# - Set optimal SQLite pragmas
# - Create summary tables
# - Vacuum the database
# - Test query performance
```

### Database Maintenance Schedule

Create a cron job for regular optimization:

```bash
# Open crontab
crontab -e

# Add monthly optimization (runs at 3 AM on the 1st of each month)
0 3 1 * * cd /home/chessstats/chess-stats && node scripts/optimize-db.js >> logs/db-optimize.log 2>&1
```

---

## Web Server Setup

### Step 1: Install Nginx

```bash
# Install Nginx
sudo apt install -y nginx

# Enable and start Nginx
sudo systemctl enable nginx
sudo systemctl start nginx
```

### Step 2: Configure Nginx

```bash
# Copy the provided nginx configuration
sudo cp nginx/nginx.conf /etc/nginx/sites-available/chess-stats

# Create symbolic link
sudo ln -s /etc/nginx/sites-available/chess-stats /etc/nginx/sites-enabled/

# Remove default site
sudo rm /etc/nginx/sites-enabled/default

# Edit configuration with your domain
sudo nano /etc/nginx/sites-available/chess-stats
```

Update these lines in the nginx config:
```nginx
server_name your-domain.com www.your-domain.com;
```

### Step 3: Test and Reload Nginx

```bash
# Test configuration
sudo nginx -t

# If successful, reload Nginx
sudo systemctl reload nginx
```

---

## SSL Configuration

### Using Let's Encrypt (Free SSL)

```bash
# Install Certbot
sudo apt install -y certbot python3-certbot-nginx

# Obtain SSL certificate
sudo certbot --nginx -d your-domain.com -d www.your-domain.com \
    --non-interactive \
    --agree-tos \
    --email your-email@example.com

# Test automatic renewal
sudo certbot renew --dry-run

# Add auto-renewal to crontab
sudo crontab -e
# Add this line:
0 3 * * * /usr/bin/certbot renew --quiet --post-hook "systemctl reload nginx"
```

### Using Custom SSL Certificate

```bash
# Create SSL directory
sudo mkdir -p /etc/nginx/ssl

# Copy your certificates
sudo cp /path/to/your-cert.crt /etc/nginx/ssl/
sudo cp /path/to/your-key.key /etc/nginx/ssl/

# Set permissions
sudo chmod 600 /etc/nginx/ssl/*

# Update nginx configuration
sudo nano /etc/nginx/sites-available/chess-stats
# Update the ssl_certificate paths
```

---

## Process Management

### Option 1: PM2 (Recommended)

```bash
# Start application with PM2
pm2 start ecosystem.config.js --env production

# Or start directly
pm2 start simple-server-pooled.js \
    --name chess-stats \
    --instances 2 \
    --exec-mode cluster \
    --max-memory-restart 1G

# Save PM2 configuration
pm2 save

# Setup PM2 to start on boot
pm2 startup systemd
# Copy and run the command provided by PM2

# Useful PM2 commands
pm2 status          # Check status
pm2 logs            # View logs
pm2 monit           # Monitor resources
pm2 reload all      # Zero-downtime reload
```

### Option 2: Docker Deployment

```bash
# Build and start with Docker Compose
docker-compose up -d --build

# View logs
docker-compose logs -f

# Scale the application
docker-compose up -d --scale chess-stats=3
```

### Option 3: Systemd Service

Create `/etc/systemd/system/chess-stats.service`:

```ini
[Unit]
Description=Chess Stats Application
After=network.target

[Service]
Type=simple
User=chessstats
WorkingDirectory=/home/chessstats/chess-stats
ExecStart=/usr/bin/node simple-server-pooled.js
Restart=on-failure
RestartSec=10
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
sudo systemctl enable chess-stats
sudo systemctl start chess-stats
sudo systemctl status chess-stats
```

---

## Monitoring & Logging

### Application Monitoring

```bash
# PM2 Monitoring
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 20M
pm2 set pm2-logrotate:retain 7
pm2 set pm2-logrotate:compress true

# Enable web monitoring
pm2 web  # Opens monitoring on port 9615
```

### Log Management

```bash
# Create log rotation configuration
sudo nano /etc/logrotate.d/chess-stats
```

Add this configuration:
```
/home/chessstats/chess-stats/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 640 chessstats chessstats
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

### Health Monitoring

Set up external monitoring:

```bash
# Using UptimeRobot, Pingdom, or similar
Monitor URL: https://your-domain.com/health
Check Interval: 1 minute
Alert After: 2 failures
```

### Custom Monitoring Endpoints

- `/health` - Basic health check
- `/monitoring/metrics` - Detailed metrics
- `/api/pool/stats` - Database pool statistics
- `/monitoring/dashboard` - Web dashboard (restrict access)

---

## Backup Strategy

### Automated Daily Backups

Create backup script `/home/chessstats/backup.sh`:

```bash
#!/bin/bash

# Configuration
BACKUP_DIR="/home/chessstats/backups"
DB_PATH="/home/chessstats/chess-stats/otb-database/complete-tournaments.db"
APP_DIR="/home/chessstats/chess-stats"
DATE=$(date +%Y%m%d-%H%M%S)
RETENTION_DAYS=30

# Create backup directory
mkdir -p $BACKUP_DIR

# Backup database
echo "Backing up database..."
sqlite3 $DB_PATH ".backup $BACKUP_DIR/db-$DATE.sqlite"
gzip $BACKUP_DIR/db-$DATE.sqlite

# Backup application files (excluding node_modules)
echo "Backing up application..."
tar -czf $BACKUP_DIR/app-$DATE.tar.gz \
    --exclude=node_modules \
    --exclude=logs \
    --exclude=.git \
    $APP_DIR

# Remove old backups
echo "Cleaning old backups..."
find $BACKUP_DIR -name "*.gz" -mtime +$RETENTION_DAYS -delete

# Optional: Upload to S3
# aws s3 sync $BACKUP_DIR s3://your-backup-bucket/ --exclude "*" --include "*.gz"

echo "Backup completed: $DATE"
```

Schedule backups:
```bash
chmod +x /home/chessstats/backup.sh
crontab -e
# Add: 0 2 * * * /home/chessstats/backup.sh >> /home/chessstats/backups/backup.log 2>&1
```

---

## Performance Tuning

### Node.js Optimization

```bash
# Increase memory limit if needed
pm2 start simple-server-pooled.js --node-args="--max-old-space-size=4096"

# Enable cluster mode for multiple cores
pm2 start simple-server-pooled.js -i max
```

### Nginx Optimization

Add to `/etc/nginx/nginx.conf`:

```nginx
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    # Enable caching
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=cache:10m max_size=1g;
    
    # Compression
    gzip on;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript;
    
    # Connection settings
    keepalive_timeout 65;
    keepalive_requests 100;
}
```

### Database Performance

```bash
# Run periodic optimization
node scripts/optimize-db.js

# Monitor slow queries
sqlite3 otb-database/complete-tournaments.db "
SELECT sql, COUNT(*) as count, AVG(elapsed_time) as avg_time
FROM sqlite_stat4
GROUP BY sql
ORDER BY avg_time DESC
LIMIT 10;"
```

---

## Security Checklist

### âœ… Essential Security Measures

- [ ] **SSH Security**
  ```bash
  # Disable root login
  sudo nano /etc/ssh/sshd_config
  # Set: PermitRootLogin no
  # Set: PasswordAuthentication no (use SSH keys)
  sudo systemctl restart sshd
  ```

- [ ] **Fail2ban Configuration**
  ```bash
  sudo apt install fail2ban
  sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
  sudo systemctl enable fail2ban
  sudo systemctl start fail2ban
  ```

- [ ] **File Permissions**
  ```bash
  chmod 600 .env.production
  chmod 644 otb-database/*.db
  chmod 755 scripts/*.js
  ```

- [ ] **Environment Variables**
  - Strong passwords (24+ characters)
  - Unique secrets for each environment
  - Regular rotation (every 90 days)

- [ ] **API Security**
  - Rate limiting enabled
  - CORS properly configured
  - API keys for sensitive endpoints

- [ ] **Regular Updates**
  ```bash
  # System updates
  sudo apt update && sudo apt upgrade
  
  # Node.js dependencies (carefully)
  npm audit
  npm audit fix
  ```

---

## Troubleshooting

### Common Issues and Solutions

#### Application Won't Start

```bash
# Check logs
pm2 logs chess-stats --lines 100

# Verify Node version
node --version  # Must be 18+

# Check port availability
sudo lsof -i :3010

# Verify environment variables
cat .env.production
```

#### Database Errors

```bash
# Check integrity
sqlite3 otb-database/complete-tournaments.db "PRAGMA integrity_check;"

# Check permissions
ls -la otb-database/

# Rebuild indexes
node scripts/optimize-db.js
```

#### High Memory Usage

```bash
# Check memory
pm2 monit

# Restart application
pm2 restart chess-stats

# Clear caches
redis-cli FLUSHALL  # If using Redis
```

#### Nginx 502 Bad Gateway

```bash
# Check if app is running
pm2 status

# Check nginx error log
sudo tail -f /var/log/nginx/error.log

# Test backend directly
curl http://localhost:3010/health
```

#### Slow Performance

```bash
# Check system resources
htop

# Check database performance
time sqlite3 otb-database/complete-tournaments.db "SELECT COUNT(*) FROM games;"

# Monitor nginx cache
curl -I https://your-domain.com/api/players/magnuscarlsen
# Look for X-Cache-Status header
```

---

## Maintenance

### Daily Tasks
- Monitor application logs: `pm2 logs`
- Check health endpoint: `curl https://your-domain.com/health`
- Review error logs: `tail -f logs/error-*.log`

### Weekly Tasks
- Review system resources: `htop`, `df -h`
- Check backup integrity
- Review security logs: `sudo fail2ban-client status`

### Monthly Tasks
- Optimize database: `node scripts/optimize-db.js`
- Update dependencies (test first): `npm update`
- Review and rotate logs
- Security audit: `npm audit`

### Updating the Application

```bash
# 1. Backup current version
tar -czf backup-$(date +%Y%m%d).tar.gz chess-stats/

# 2. Pull latest changes
cd chess-stats
git pull origin main

# 3. Install dependencies
npm ci --production

# 4. Build frontend
cd frontend
npm ci --production
npm run build
cd ..

# 5. Run migrations if any
# node scripts/migrate.js

# 6. Reload application (zero downtime)
pm2 reload chess-stats

# 7. Verify deployment
curl https://your-domain.com/health
```

### Emergency Rollback

```bash
# Stop application
pm2 stop chess-stats

# Restore backup
tar -xzf backup-YYYYMMDD.tar.gz

# Restart
pm2 start chess-stats

# Verify
curl https://your-domain.com/health
```

---

## Support Resources

### Monitoring URLs
- Health Check: `https://your-domain.com/health`
- Metrics: `https://your-domain.com/monitoring/metrics`
- PM2 Web: `http://your-server:9615`

### Log Locations
- Application: `/home/chessstats/chess-stats/logs/`
- Nginx: `/var/log/nginx/`
- PM2: `~/.pm2/logs/`
- System: `/var/log/syslog`

### Useful Commands
```bash
# Application
pm2 status              # Check app status
pm2 logs --lines 50    # View recent logs
pm2 monit              # Monitor resources

# Database
sqlite3 otb-database/complete-tournaments.db  # Database console
node scripts/optimize-db.js                   # Optimize database

# System
htop                   # Resource monitor
df -h                  # Disk usage
netstat -tlpn         # Network connections
systemctl status      # Service status
```

---

## Contact & Support

- **Documentation**: GitHub repository README
- **Issues**: GitHub Issues page
- **Security**: Report vulnerabilities privately
- **Monitoring**: Check `/monitoring/dashboard`

---

**Last Updated**: 2024  
**Version**: 1.0.0  
**License**: See LICENSE file